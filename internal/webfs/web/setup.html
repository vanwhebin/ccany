<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCany - é¦–æ¬¡è®¾ç½®</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        /* Setupé¡µé¢ç‰¹å®šæ ·å¼ */
        .setup-container {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .setup-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .setup-header .logo {
            margin-bottom: var(--space-6);
        }

        .setup-header .subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: var(--space-4);
        }

        .version-info {
            margin-top: var(--space-4);
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            justify-content: center;
            gap: var(--space-4);
        }

        .version-info span {
            font-weight: var(--font-weight-medium);
        }

        .setup-step {
            margin-bottom: var(--space-8);
        }

        .step-title {
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-weight: var(--font-weight-semibold);
        }

        .step-number {
            background: var(--claude-primary);
            color: var(--text-inverse);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: 14px;
        }

        .password-requirements {
            margin-top: var(--space-2);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .setup-button {
            width: 100%;
            padding: var(--space-4) var(--space-6);
            background: var(--claude-primary);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: var(--transition-all);
            outline: none;
            margin-top: var(--space-8);
        }

        .setup-button:hover:not(:disabled) {
            background: var(--claude-primary-hover);
            transform: translateY(-1px);
        }

        .setup-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            font-size: 14px;
        }

        .alert-error {
            background: var(--error-light);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: var(--space-6);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--claude-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .success-message {
            display: none;
            text-align: center;
            margin-top: var(--space-6);
        }

        .success-message h3 {
            color: var(--success-color);
            margin-bottom: var(--space-3);
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
        }

        .success-message p {
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
        }

        .continue-button {
            width: 100%;
            padding: var(--space-4) var(--space-6);
            background: var(--claude-primary);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: var(--transition-all);
            outline: none;
        }

        .continue-button:hover {
            background: var(--claude-primary-hover);
            transform: translateY(-1px);
        }

        body {
            background: linear-gradient(135deg, var(--claude-primary-lighter) 0%, var(--claude-primary-light) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
        }
    </style>
</head>

<body>
    <div class="setup-container">
        <div class="setup-header">
            <div class="logo">
                <div class="logo-icon">ğŸ¤–</div>
                <h1>CCany</h1>
            </div>
            <p class="subtitle" data-i18n="setup.welcome">æ¬¢è¿ä½¿ç”¨ CCanyï¼è®©æˆ‘ä»¬å®Œæˆé¦–æ¬¡è®¾ç½®</p>
            <div class="version-info">
                <span data-i18n="setup.version">ç‰ˆæœ¬: <span id="appVersion">-</span></span>
                <span data-i18n="setup.build_time">æ„å»ºæ—¶é—´: <span id="buildTime">-</span></span>
            </div>
        </div>

        <div id="setupForm">
            <div class="setup-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    <span data-i18n="setup.create_admin">åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·</span>
                </div>

                <div id="alertContainer"></div>

                <form id="adminSetupForm">
                    <div class="form-group">
                        <label for="username" data-i18n="setup.admin_username">ç®¡ç†å‘˜ç”¨æˆ·å</label>
                        <input type="text" id="username" name="username" required minlength="3" maxlength="50">
                    </div>

                    <div class="form-group">
                        <label for="password" data-i18n="setup.admin_password">ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="password" name="password" required minlength="6">
                        <div class="password-requirements" data-i18n="setup.password_requirements">
                            å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦ï¼Œå»ºè®®åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" data-i18n="setup.confirm_password">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>

                    <button type="submit" class="setup-button" data-i18n="setup.create_account">åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·</button>
                </form>
            </div>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p data-i18n="setup.creating_account">æ­£åœ¨åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·...</p>
            </div>
        </div>

        <div class="success-message" id="successMessage">
            <h3 data-i18n="setup.setup_complete">âœ… è®¾ç½®å®Œæˆï¼</h3>
            <p data-i18n="setup.account_created">ç®¡ç†å‘˜è´¦æˆ·å·²åˆ›å»ºæˆåŠŸã€‚æ‚¨ç°åœ¨å¯ä»¥ç™»å½•åˆ°ç³»ç»Ÿã€‚</p>
            <button class="continue-button" onclick="goToLogin()" data-i18n="setup.go_to_login">å‰å¾€ç™»å½•</button>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
        <svg class="theme-toggle-icon sun" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
            <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg class="theme-toggle-icon moon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <script>
        document.getElementById('adminSetupForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æ¶ˆæ¯
            clearAlerts();

            // éªŒè¯å¯†ç 
            if (password !== confirmPassword) {
                showAlert('å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('setupForm').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';

            try {
                const response = await fetch('/api/setup/admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // è®¾ç½®æˆåŠŸ
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                } else {
                    // è®¾ç½®å¤±è´¥
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('setupForm').style.display = 'block';
                    showAlert(result.error || 'åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Setup error:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('setupForm').style.display = 'block';
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        });

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
        }

        function clearAlerts() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
        }

        function goToLogin() {
            window.location.href = '/';
        }

        // é˜²æ­¢é‡å¤æ£€æŸ¥çš„æ ‡å¿—
        let hasCheckedSetup = false;

        // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¾ç½®å‘å¯¼
        async function checkSetupRequired() {
            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (hasCheckedSetup) {
                return;
            }
            hasCheckedSetup = true;

            try {
                const response = await fetch('/api/setup/check');
                const result = await response.json();

                if (!result.setup_required) {
                    console.log('Setup not required, redirecting to login page');
                    // ä¸éœ€è¦è®¾ç½®ï¼Œç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µ
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Failed to check setup status:', error);
                hasCheckedSetup = false; // å‡ºé”™æ—¶å…è®¸é‡è¯•
            }
        }

        // åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
        async function loadVersionInfo() {
            try {
                const response = await fetch('/version');
                const data = await response.json();

                const appVersionElement = document.getElementById('appVersion');
                const buildTimeElement = document.getElementById('buildTime');

                if (appVersionElement) {
                    appVersionElement.textContent = data.version || 'dev';
                }

                if (buildTimeElement) {
                    buildTimeElement.textContent = data.build_time || 'unknown';
                }
            } catch (error) {
                console.error('è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', error);
                const appVersionElement = document.getElementById('appVersion');
                const buildTimeElement = document.getElementById('buildTime');

                if (appVersionElement) {
                    appVersionElement.textContent = 'unknown';
                }

                if (buildTimeElement) {
                    buildTimeElement.textContent = 'unknown';
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¾ç½®çŠ¶æ€
        window.addEventListener('load', function () {
            initializeI18n(); // Initialize translations first
            checkSetupRequired();
            loadVersionInfo();
            // Initialize theme controller for setup page
            if (typeof ThemeController !== 'undefined') {
                new ThemeController();
            } else {
                // Fallback theme controller for setup page
                initializeThemeToggle();
            }
        });

        // Fallback theme controller for setup page
        function initializeThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            if (!themeToggle) return;

            // Get current theme
            let currentTheme = localStorage.getItem('theme') || 
                               (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

            // Apply theme
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                updateToggleButton(theme);
            }

            // Update toggle button
            function updateToggleButton(theme) {
                const sunIcon = themeToggle.querySelector('.sun');
                const moonIcon = themeToggle.querySelector('.moon');
                
                if (theme === 'dark') {
                    themeToggle.title = 'åˆ‡æ¢åˆ°æ˜äº®æ¨¡å¼';
                } else {
                    themeToggle.title = 'åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼';
                }
            }

            // Toggle theme
            function toggleTheme() {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(currentTheme);
                
                // Add click animation
                themeToggle.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    themeToggle.style.transform = '';
                }, 150);
            }

            // Initialize
            applyTheme(currentTheme);
            themeToggle.addEventListener('click', toggleTheme);
        }

        // Simple i18n for setup page
        function initializeI18n() {
            // Detect language
            const currentLanguage = localStorage.getItem('preferred_language') || 
                                   navigator.language.startsWith('zh') ? 'zh-CN' : 'en-US';
            
            // Simple translation function
            function t(key) {
                const translations = {
                    'zh-CN': {
                        'setup.welcome': 'æ¬¢è¿ä½¿ç”¨ CCanyï¼è®©æˆ‘ä»¬å®Œæˆé¦–æ¬¡è®¾ç½®',
                        'setup.version': 'ç‰ˆæœ¬:',
                        'setup.build_time': 'æ„å»ºæ—¶é—´:',
                        'setup.create_admin': 'åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·',
                        'setup.admin_username': 'ç®¡ç†å‘˜ç”¨æˆ·å',
                        'setup.admin_password': 'ç®¡ç†å‘˜å¯†ç ',
                        'setup.confirm_password': 'ç¡®è®¤å¯†ç ',
                        'setup.password_requirements': 'å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦ï¼Œå»ºè®®åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦',
                        'setup.create_account': 'åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·',
                        'setup.creating_account': 'æ­£åœ¨åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·...',
                        'setup.setup_complete': 'âœ… è®¾ç½®å®Œæˆï¼',
                        'setup.account_created': 'ç®¡ç†å‘˜è´¦æˆ·å·²åˆ›å»ºæˆåŠŸã€‚æ‚¨ç°åœ¨å¯ä»¥ç™»å½•åˆ°ç³»ç»Ÿã€‚',
                        'setup.go_to_login': 'å‰å¾€ç™»å½•'
                    },
                    'en-US': {
                        'setup.welcome': 'Welcome to CCany! Let\'s complete the initial setup',
                        'setup.version': 'Version:',
                        'setup.build_time': 'Build Time:',
                        'setup.create_admin': 'Create Administrator Account',
                        'setup.admin_username': 'Administrator Username',
                        'setup.admin_password': 'Administrator Password',
                        'setup.confirm_password': 'Confirm Password',
                        'setup.password_requirements': 'Password must be at least 6 characters, recommend including uppercase letters, lowercase letters, numbers and special characters',
                        'setup.create_account': 'Create Administrator Account',
                        'setup.creating_account': 'Creating administrator account...',
                        'setup.setup_complete': 'âœ… Setup Complete!',
                        'setup.account_created': 'Administrator account has been created successfully. You can now log in to the system.',
                        'setup.go_to_login': 'Go to Login'
                    }
                };
                
                return translations[currentLanguage]?.[key] || key;
            }
            
            // Apply translations
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = t(key);
                element.textContent = translation;
            });
        }
    </script>
</body>

</html>